<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Memory Viewer</title>
  <link rel="icon" href="/static/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <header class="border-b bg-white">
    <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold">Memory Viewer</h1>
        <div class="text-xs text-slate-500 mt-1">
          User: <span class="font-medium text-slate-700">{{ user_id }}</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a href="/" class="rounded-lg border px-3 py-2 text-sm hover:bg-slate-50">Back to chat</a>
        <button class="rounded-lg bg-slate-900 px-3 py-2 text-sm text-white hover:bg-slate-800" onclick="refreshAll()">
          Refresh
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6 space-y-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section class="rounded-xl border bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold">Profile memories</h2>
          <span id="countProfile" class="text-xs text-slate-500"></span>
        </div>
        <div id="profileList" class="mt-3 space-y-2"></div>
      </section>

      <section class="rounded-xl border bg-white p-4 shadow-sm lg:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold">Chat summaries</h2>
          <span id="countSummaries" class="text-xs text-slate-500"></span>
        </div>
        <div id="summaryList" class="mt-3 space-y-2"></div>
      </section>
    </div>

    <section class="rounded-xl border bg-white p-4 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold">Uploaded context</h2>
        <span id="countUploads" class="text-xs text-slate-500"></span>
      </div>
      <div id="uploadList" class="mt-3 space-y-2"></div>
      <div class="mt-3 text-xs text-slate-500">
        Note: PDFs appear as many chunks. Images appear as a single “caption” entry (no OCR).
      </div>
    </section>
  </main>

  <script>
  function card(title, meta, text) {
    var div = document.createElement("div");
    div.className = "rounded-lg border bg-slate-50 p-3";

    var t = document.createElement("div");
    t.className = "text-xs font-medium text-slate-700";
    t.textContent = title;

    var m = document.createElement("div");
    m.className = "text-[11px] text-slate-500 mt-1";
    m.textContent = meta;

    var b = document.createElement("div");
    b.className = "text-sm text-slate-900 mt-2 whitespace-pre-wrap";
    b.textContent = text;

    div.appendChild(t);
    div.appendChild(m);
    div.appendChild(b);
    return div;
  }

  function sectionHeader(label, count) {
    var wrap = document.createElement("div");
    wrap.className = "flex items-center justify-between mt-3";

    var left = document.createElement("div");
    left.className = "text-xs font-semibold text-slate-700";
    left.textContent = label;

    var right = document.createElement("div");
    right.className = "text-[11px] text-slate-500";
    right.textContent = count + " items";

    wrap.appendChild(left);
    wrap.appendChild(right);
    return wrap;
  }

  async function loadProfile() {
    var resp = await fetch("/api/memory/profile");
    var data = await resp.json();
    var list = document.getElementById("profileList");
    list.innerHTML = "";

    var items = data.items || [];

    // Default: if scope is missing (old data), treat as identity
    var identity = [];
    var focus = [];

    for (var i = 0; i < items.length; i++) {
      var it = items[i] || {};
      var scope = (it.scope || "identity").toLowerCase();

      if (scope === "focus") {
        focus.push(it);
      } else {
        identity.push(it);
      }
    }

    document.getElementById("countProfile").textContent = items.length + " items";

    // ---- Identity section ----
    list.appendChild(sectionHeader("IDENTITY", identity.length));
    for (var a = 0; a < identity.length; a++) {
      var itA = identity[a] || {};
      var titleA = (itA.category || "profile").toUpperCase();
      var metaA = "scope: " + (itA.scope || "identity") + " • updated_at: " + (itA.updated_at || "-");
      var textA = itA.text || "";
      list.appendChild(card(titleA, metaA, textA));
    }

    // ---- Focus section ----
    list.appendChild(sectionHeader("CURRENT FOCUS", focus.length));
    for (var b = 0; b < focus.length; b++) {
      var itB = focus[b] || {};
      var titleB = (itB.category || "profile").toUpperCase();
      var metaB = "scope: " + (itB.scope || "focus") + " • updated_at: " + (itB.updated_at || "-");
      var textB = itB.text || "";
      list.appendChild(card(titleB, metaB, textB));
    }
  }

  async function loadSummaries() {
    var resp = await fetch("/api/memory/summaries");
    var data = await resp.json();
    var list = document.getElementById("summaryList");
    list.innerHTML = "";

    var items = data.items || [];
    document.getElementById("countSummaries").textContent = items.length + " items";

    for (var i = 0; i < items.length; i++) {
      var it = items[i] || {};
      var title = "CHAT " + (it.chat_id || "").slice(0, 8);
      var meta = "created_at: " + (it.created_at || "-");
      var text = it.text || "";
      list.appendChild(card(title, meta, text));
    }
  }

  async function loadUploads() {
    var resp = await fetch("/api/memory/uploads");
    var data = await resp.json();
    var list = document.getElementById("uploadList");
    list.innerHTML = "";

    var items = data.items || [];
    document.getElementById("countUploads").textContent = items.length + " items";

    for (var i = 0; i < items.length; i++) {
      var it = items[i] || {};
      var title = (it.context_type || "context").toUpperCase() + " • " + (it.file_name || "file");
      var meta = "file_id: " + (it.file_id || "-") + " • chunk: " + (it.chunk_index || 0);
      var text = it.text || "";
      list.appendChild(card(title, meta, text));
    }
  }

  async function refreshAll() {
    await loadProfile();
    await loadSummaries();
    await loadUploads();
  }

  refreshAll();
</script>
</body>
</html>
